{{/*
  Shortcode: trials-table
  Params:
    - subject_id (required): numeric subject id to filter trials
  Behavior:
    - Always links externally (opens in new tab)
    - Shows identifiers (NCT, EUCT, EudraCT) beneath the title when available
*/}}
{{ $subject := .Get "subject_id" }}

{{ if not $subject }}
<div class="alert alert-warning" role="alert">
  Missing required parameter: subject_id
  <div class="small text-muted mt-2">Usage: {{`{{< trials-table subject_id="1" >}}`}}</div>
  </div>
{{ else }}
<div class="table-responsive mb-3" data-subject="{{ $subject }}">
  <table class="table table-sm table-striped table-hover">
    <caption class="sr-only">Latest clinical trials</caption>
    <thead class="thead-light">
      <tr>
        <th scope="col" class="text-left">Title</th>
        <th scope="col" style="width: 180px;">Published</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td colspan="2" class="text-center text-muted py-4">
          <div class="spinner-border text-primary mr-2" role="status" aria-hidden="true" style="width: 1.25rem; height: 1.25rem;"></div>
          Loading trials...
        </td>
      </tr>
    </tbody>
  </table>
  </div>

<script>
(function() {
  // Find root wrapper (the element just before this script tag)
  var root = (document.currentScript && document.currentScript.previousElementSibling) || null;
  if (!root || !root.hasAttribute('data-subject')) { return; }

  var SUBJECT_ID = root.getAttribute('data-subject');

  function sanitizeSlug(title) {
    try {
      return String(title)
        .replace(/[^\w\s-]/g, '')
        .replace(/\s+/g, '-')
        .toLowerCase();
    } catch (e) { return ''; }
  }

  function formatDate(dateStr) {
    try {
      var d = new Date(dateStr);
      if (isNaN(d.getTime())) return '';
  // Use a valid BCP47 locale tag
  return d.toLocaleDateString('en-GB', { year: 'numeric', month: 'long', day: 'numeric' });
    } catch (e) { return ''; }
  }

  function esc(str) {
    return String(str || '')
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;');
  }

  function buildIdentifiers(ident) {
    if (!ident || typeof ident !== 'object') return '';
    var parts = [];
    if (ident.nct) parts.push('NCT: ' + esc(ident.nct));
    if (ident.euct) parts.push('EUCT: ' + esc(ident.euct));
    if (ident.eudract) parts.push('EudraCT: ' + esc(ident.eudract));
    if (!parts.length) return '';
    return '<div class="small text-muted mt-1">' + parts.join(' â€¢ ') + '</div>';
  }

  // Choose the best available date from the trial payload
  function pickDate(trial) {
    if (!trial) return '';
    var candidates = [
      trial.published_date,
      trial.date_registration,
      trial.results_date_completed,
      trial.last_refreshed_on,
      trial.discovery_date,
      trial.date_enrollement // note: spelled like this in payload
    ];
    for (var i = 0; i < candidates.length; i++) {
      var v = candidates[i];
      if (v && String(v).trim()) return v;
    }
    return '';
  }

  function buildRow(trial) {
    var title = trial && trial.title ? trial.title : 'Untitled';
  var dateStr = pickDate(trial);
  var published = dateStr ? formatDate(dateStr) : '';
    var href = (trial && trial.link) ? trial.link : '#';
    var ids = buildIdentifiers(trial && trial.identifiers);

    var safeTitle = esc(title);
    var safePublished = esc(published || '');

    return '<tr>' +
             '<td class="align-middle text-left">' +
               '<a href="' + href + '" class="text-dark" target="_blank" rel="noopener noreferrer">' + safeTitle + '</a>' +
               ids +
             '</td>' +
             '<td class="align-middle"><span class="text-secondary">' + safePublished + '</span></td>' +
           '</tr>';
  }

  function renderRows(rowsHtml) {
    var tbody = root.querySelector('tbody');
    if (!tbody) return;
    tbody.innerHTML = rowsHtml;
  }

  function renderError(message) {
    renderRows('<tr><td colspan="2" class="text-center text-danger py-4">' + (message || 'Failed to load trials.') + '</td></tr>');
  }

  function fetchTrials() {
    var url = 'https://api.gregory-ms.com/trials/?format=json&team_id=1&subject_id=' + encodeURIComponent(SUBJECT_ID) + '&ordering=-published_date&page_size=10';
    var controller = window.AbortController ? new AbortController() : null;
    var timeout = setTimeout(function(){ if (controller) controller.abort(); }, 7000);

    fetch(url, controller ? { signal: controller.signal } : undefined)
      .then(function(resp){
        if (!resp.ok) throw new Error('HTTP ' + resp.status);
        return resp.json();
      })
      .then(function(data){
        var results = Array.isArray(data) ? data : (Array.isArray(data.results) ? data.results : []);
        if (!results.length) {
          renderRows('<tr><td colspan="2" class="text-center text-muted py-4">No trials found.</td></tr>');
          return;
        }
        var rows = results.slice(0, 10).map(buildRow).join('');
        renderRows(rows);
      })
      .catch(function(err){
        console && console.error && console.error('[trials-table]', err);
        renderError('Unable to load trials.');
      })
      .finally(function(){ clearTimeout(timeout); });
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', fetchTrials);
  } else {
    fetchTrials();
  }
})();
</script>
{{ end }}
