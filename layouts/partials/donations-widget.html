<!-- Donations Widget - Compact Version -->
<div class="donations-widget bg-white rounded shadow-sm p-4">
	<div class="row align-items-center mb-3">
		<div class="col">
			<h5 class="mb-0 text-gradient text-primary">Recent Donations</h5>
			<small class="text-muted">Help keep Gregory-MS running</small>
		</div>
		<div class="col-auto">
			<a href="https://donate.stripe.com/4gMbJ02IA3DqgfU93Y7N602" 
			   target="_blank" 
			   class="btn btn-sm btn-outline-primary"
			   data-umami-event="click--donate-button--widget">
				<i class="fas fa-heart me-1"></i>
				Donate
			</a>
		</div>
	</div>
	
	<div class="donations-list" id="donationsWidgetList">
		<div class="text-center py-3">
			<div class="spinner-border spinner-border-sm text-primary" role="status"></div>
			<small class="text-muted d-block mt-2">Loading...</small>
		</div>
	</div>
	
	<div class="row text-center mt-3 pt-3 border-top">
		<div class="col-6">
			<div class="text-primary font-weight-bold" id="widgetDonorCount">-</div>
			<small class="text-muted">Contributors</small>
		</div>
		<div class="col-6">
			<div class="text-success font-weight-bold" id="widgetTotalAmount">€-</div>
			<small class="text-muted">This Year</small>
		</div>
	</div>
</div>

<script>
(function() {
	'use strict';
	
	function loadDonationsWidget() {
		const listContainer = document.getElementById('donationsWidgetList');
		const donorCountEl = document.getElementById('widgetDonorCount');
		const totalAmountEl = document.getElementById('widgetTotalAmount');
		
		if (!listContainer) return;
		
		fetch('https://stripe-transparency.dash-tech-daf.workers.dev')
			.then(response => response.json())
			.then(donations => {
				// Clear loading state
				listContainer.innerHTML = '';
				
				if (donations.length === 0) {
					listContainer.innerHTML = `
						<div class="text-center py-2">
							<small class="text-muted">No donations yet. Be the first!</small>
						</div>
					`;
					return;
				}
				
				// Get recent donations (last 5)
				const recentDonations = donations
					.sort((a, b) => new Date(b.charge_date) - new Date(a.charge_date))
					.slice(0, 5);
				
				// Calculate stats
				const currentYear = new Date().getFullYear();
				const yearlyDonations = donations.filter(d => 
					new Date(d.charge_date).getFullYear() === currentYear
				);
				const totalAmount = yearlyDonations.reduce((sum, d) => 
					sum + parseFloat(d.amount_paid || 0), 0
				);
				const uniqueDonors = new Set(donations.map(d => d.email)).size;
				
				// Update stats
				if (donorCountEl) donorCountEl.textContent = uniqueDonors;
				if (totalAmountEl) totalAmountEl.textContent = `€${totalAmount.toFixed(0)}`;
				
				// Create donation items
				recentDonations.forEach((donation, index) => {
					const item = document.createElement('div');
					item.className = `d-flex align-items-center py-2 ${index < recentDonations.length - 1 ? 'border-bottom' : ''}`;
					
					const displayName = donation.name || 'Anonymous';
					const date = new Date(donation.charge_date);
					const daysAgo = Math.floor((Date.now() - date.getTime()) / (1000 * 60 * 60 * 24));
					const timeAgo = daysAgo === 0 ? 'Today' : 
									daysAgo === 1 ? 'Yesterday' : 
									daysAgo < 7 ? `${daysAgo} days ago` : 
									date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
					
					item.innerHTML = `
						<div class="avatar avatar-xs bg-gradient-primary rounded-circle me-2">
							<span class="text-white text-xs">${displayName.charAt(0).toUpperCase()}</span>
						</div>
						<div class="flex-grow-1 min-width-0">
							<div class="d-flex justify-content-between align-items-center">
								<span class="text-sm font-weight-semibold text-truncate me-2">${displayName}</span>
								<span class="badge badge-sm badge-success">${donation.amount_paid} ${donation.currency.toUpperCase()}</span>
							</div>
							<small class="text-muted">${timeAgo}</small>
						</div>
					`;
					
					listContainer.appendChild(item);
				});
			})
			.catch(error => {
				console.error('Error loading donations widget:', error);
				listContainer.innerHTML = `
					<div class="text-center py-2">
						<small class="text-muted">Unable to load donations</small>
					</div>
				`;
			});
	}
	
	// Load widget when DOM is ready
	if (document.readyState === 'loading') {
		document.addEventListener('DOMContentLoaded', loadDonationsWidget);
	} else {
		loadDonationsWidget();
	}
})();
</script>

<style>
.donations-widget {
	max-width: 400px;
}
.min-width-0 {
	min-width: 0;
}
</style>
